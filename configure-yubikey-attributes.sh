#!/bin/bash

# ğŸ” YubiKey + Custom Attributes - Keycloak Configuration Script
# This script provides step-by-step manual configuration instructions

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘         ğŸ” YubiKey + Custom Attributes Configuration Guide                  â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "This guide will help you configure:"
echo "  âœ“ Custom user attributes (age, mobile, address, profession)"
echo "  âœ“ YubiKey WebAuthn authentication"
echo "  âœ“ SAML attribute mappers for both SPs"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Check if Keycloak is running
if ! docker ps | grep -q keycloak-sso; then
    echo "âŒ Keycloak is not running!"
    echo "   Start it with: bash start-keycloak.sh"
    exit 1
fi

echo "âœ… Keycloak is running"
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“"
echo "â”ƒ                    PART 1: Custom User Attributes                           â”ƒ"
echo "â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›"
echo ""
echo "1. Open: http://localhost:8080"
echo "2. Login: admin / admin"
echo "3. Select 'demo' realm (top-left dropdown)"
echo "4. Click 'Realm settings' â†’ 'User profile' tab"
echo "5. Add these 4 custom attributes:"
echo ""
echo "   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "   â”‚ Attribute 1: age                                            â”‚"
echo "   â”‚   â€¢ Display name: Age                                       â”‚"
echo "   â”‚   â€¢ Required: Yes                                           â”‚"
echo "   â”‚   â€¢ User can edit: âœ“                                        â”‚"
echo "   â”‚   â€¢ Validator: integer (optional)                           â”‚"
echo "   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo ""
echo "   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "   â”‚ Attribute 2: mobile                                         â”‚"
echo "   â”‚   â€¢ Display name: Mobile Number                             â”‚"
echo "   â”‚   â€¢ Required: Yes                                           â”‚"
echo "   â”‚   â€¢ User can edit: âœ“                                        â”‚"
echo "   â”‚   â€¢ Validator: length (min:10, max:15) (optional)           â”‚"
echo "   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo ""
echo "   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "   â”‚ Attribute 3: address                                        â”‚"
echo "   â”‚   â€¢ Display name: Address                                   â”‚"
echo "   â”‚   â€¢ Required: No                                            â”‚"
echo "   â”‚   â€¢ User can edit: âœ“                                        â”‚"
echo "   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo ""
echo "   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "   â”‚ Attribute 4: profession                                     â”‚"
echo "   â”‚   â€¢ Display name: Profession                                â”‚"
echo "   â”‚   â€¢ Required: No                                            â”‚"
echo "   â”‚   â€¢ User can edit: âœ“                                        â”‚"
echo "   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo ""
read -p "Press Enter when you've added all 4 attributes..."
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“"
echo "â”ƒ                   PART 2: YubiKey WebAuthn Setup                            â”ƒ"
echo "â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›"
echo ""
echo "Step 2.1: Enable WebAuthn Required Actions"
echo "  1. Click 'Authentication' (left sidebar)"
echo "  2. Click 'Required actions' tab"
echo "  3. Find 'Webauthn Register Passwordless' â†’ Enable it"
echo "  4. Find 'Webauthn Register' â†’ Enable it"
echo ""
read -p "Press Enter when done..."
echo ""

echo "Step 2.2: Create WebAuthn Authentication Flow"
echo "  1. Click 'Flows' tab"
echo "  2. Click 'Create flow'"
echo "  3. Name: YubiKey Browser Flow"
echo "  4. Flow type: Basic flow â†’ Create"
echo ""
echo "  5. Add steps to the flow:"
echo "     a) Add step: Cookie"
echo "     b) Add step: WebAuthn Passwordless Authenticator"
echo "        - Set to: ALTERNATIVE"
echo "     c) Add sub-flow: 'Forms' (Basic flow)"
echo "        - In Forms sub-flow:"
echo "          â€¢ Add step: Username Password Form â†’ REQUIRED"
echo "          â€¢ Add step: WebAuthn Authenticator â†’ REQUIRED"
echo ""
read -p "Press Enter when flow is created..."
echo ""

echo "Step 2.3: Bind the Flow"
echo "  1. In 'Flows' tab, find 'Browser flow' dropdown at top"
echo "  2. Action â†’ Bind flow"
echo "  3. Select 'Browser flow'"
echo "  4. Click Save"
echo ""
read -p "Press Enter when bound..."
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“"
echo "â”ƒ                  PART 3: SAML Attribute Mappers (SP1)                       â”ƒ"
echo "â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›"
echo ""
echo "1. Click 'Clients' â†’ 'saml-sp-1'"
echo "2. Click 'Client scopes' tab"
echo "3. Click 'saml-sp-1-dedicated' scope"
echo "4. Click 'Add mapper' â†’ 'By configuration'"
echo ""
echo "Add these 6 mappers:"
echo ""
echo "   Mapper 1: Username"
echo "     â€¢ Type: User Property"
echo "     â€¢ Name: username-mapper"
echo "     â€¢ Property: username"
echo "     â€¢ SAML Attribute Name: username"
echo "     â€¢ SAML Attribute NameFormat: Basic"
echo ""
echo "   Mapper 2: Email"
echo "     â€¢ Type: User Property"
echo "     â€¢ Name: email-mapper"
echo "     â€¢ Property: email"
echo "     â€¢ SAML Attribute Name: email"
echo "     â€¢ SAML Attribute NameFormat: Basic"
echo ""
echo "   Mapper 3: Age"
echo "     â€¢ Type: User Attribute"
echo "     â€¢ Name: age-mapper"
echo "     â€¢ User Attribute: age"
echo "     â€¢ SAML Attribute Name: age"
echo "     â€¢ SAML Attribute NameFormat: Basic"
echo ""
echo "   Mapper 4: Mobile"
echo "     â€¢ Type: User Attribute"
echo "     â€¢ Name: mobile-mapper"
echo "     â€¢ User Attribute: mobile"
echo "     â€¢ SAML Attribute Name: mobile"
echo "     â€¢ SAML Attribute NameFormat: Basic"
echo ""
echo "   Mapper 5: Address"
echo "     â€¢ Type: User Attribute"
echo "     â€¢ Name: address-mapper"
echo "     â€¢ User Attribute: address"
echo "     â€¢ SAML Attribute Name: address"
echo "     â€¢ SAML Attribute NameFormat: Basic"
echo ""
echo "   Mapper 6: Profession"
echo "     â€¢ Type: User Attribute"
echo "     â€¢ Name: profession-mapper"
echo "     â€¢ User Attribute: profession"
echo "     â€¢ SAML Attribute Name: profession"
echo "     â€¢ SAML Attribute NameFormat: Basic"
echo ""
read -p "Press Enter when all 6 mappers are added for SP1..."
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“"
echo "â”ƒ                  PART 4: SAML Attribute Mappers (SP2)                       â”ƒ"
echo "â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›"
echo ""
echo "Repeat the EXACT same 6 mappers for SP2:"
echo ""
echo "1. Click 'Clients' â†’ 'saml-sp-2'"
echo "2. Click 'Client scopes' tab"
echo "3. Click 'saml-sp-2-dedicated' scope"
echo "4. Add the same 6 mappers (username, email, age, mobile, address, profession)"
echo ""
read -p "Press Enter when all 6 mappers are added for SP2..."
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“"
echo "â”ƒ                     PART 5: Update Test User                                â”ƒ"
echo "â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›"
echo ""
echo "1. Click 'Users' â†’ Find 'testuser'"
echo "2. Click 'Attributes' tab"
echo "3. Add these attributes:"
echo ""
echo "   â€¢ age: 30"
echo "   â€¢ mobile: +1-555-0100"
echo "   â€¢ address: 123 Main Street, New York, NY 10001"
echo "   â€¢ profession: Software Developer"
echo ""
echo "4. Click 'Save'"
echo ""
read -p "Press Enter when user attributes are saved..."
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“"
echo "â”ƒ                    PART 6: Register YubiKey                                 â”ƒ"
echo "â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›"
echo ""
echo "Option A: User Self-Registration (Recommended)"
echo "  1. Logout from admin console"
echo "  2. Open: http://localhost:8080/realms/demo/account"
echo "  3. Login: testuser / password123"
echo "  4. Click 'Account security' â†’ 'Signing in'"
echo "  5. Find 'Passwordless' section"
echo "  6. Click 'Set up Security Key'"
echo "  7. Insert YubiKey and touch when LED blinks"
echo "  8. Give it a name (e.g., 'My YubiKey')"
echo "  9. Click 'Save'"
echo ""
echo "Option B: Skip for now (test without YubiKey first)"
echo "  You can still test SAML attribute mapping without YubiKey"
echo ""
read -p "Press Enter when YubiKey is registered (or skipping)..."
echo ""

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                        âœ… Configuration Complete!                            â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ğŸ¯ Next Steps:"
echo ""
echo "1. Restart Django service providers:"
echo "   kill \$(ps aux | grep 'runserver.*8001' | awk '{print \$2}')"
echo "   kill \$(ps aux | grep 'runserver.*8002' | awk '{print \$2}')"
echo "   nohup ./venv/bin/python manage.py runserver 127.0.0.1:8001 > sp1.log 2>&1 &"
echo "   cd SAML_DJNAGO_2"
echo "   nohup ../venv/bin/python manage.py runserver 127.0.0.1:8002 > sp2.log 2>&1 &"
echo ""
echo "2. Test the flow:"
echo "   â€¢ Open: http://127.0.0.1:8001/saml/login/"
echo "   â€¢ Login with: testuser / password123"
echo "   â€¢ (Optional) Touch YubiKey when prompted"
echo "   â€¢ Verify attributes displayed on success page!"
echo ""
echo "3. View server logs to see attribute output:"
echo "   tail -f sp1.log"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ“š Documentation: YUBIKEY_CUSTOM_ATTRIBUTES_GUIDE.md"
echo ""
